---
title: "Final report"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true

---

```{r setup, include=FALSE}
library(tidyverse)
library(corrplot)
library(ggpubr)
library(readxl)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme_bw() + theme(legend.position = "bottom"))
```

# Motivation

## Some facts about suicide

* About 800,000 people died by suicide in global every year, which accounts for 1.4% of all deaths worldwide.

* The annual U.S. suicide rate increased 10% between 2014 and 2017 according to the CDCâ€™s NCHS

* In 2015, suicide has become the second leading cause of death among 15-34 age group and the third leading cause of death between the ages of 10-14 in the USA.

* It is reported that in 2016 suicide was the 10th leading cause of death in the U.S., imposing a cost of $69 billion to the US annually.


On the one hand, almost all the risk factors for the suicide are preventable. Usually, people are not aware of the risk factors of suicide and situate themselves in the dangerous environment. We believe that a better understanding of potential risk factors is essential for the prevention of suicide.

```{r, message=FALSE, warning=FALSE}
usa_suicide = 
  read_xlsx("./data/suicide_age_gender.xlsx") %>% 
  janitor::clean_names() %>% 
  filter(is.na(ten_year_age_groups)) %>% 
  drop_na(gender) %>% 
  select(year, state, gender, deaths, population) %>% 
  group_by(year) %>% 
  summarize(
    deaths = sum(deaths),
    population = sum(population)
  ) %>% 
  mutate(
    suicide_rate = deaths * 100000/population
  ) %>% 
  select(year,suicide_rate)

global_suicide = 
  read_csv("./data/master.csv") %>% 
  janitor::clean_names() %>% 
  filter(year >= 1999) %>% 
  group_by(year) %>% 
  summarize(
    deaths = sum(suicides_no),
    population = sum(population)
  ) %>% 
  mutate(
    suicide_global = deaths*100000/population
  ) %>% 
  select(year, suicide_global)

suicide_rate = 
  left_join(usa_suicide, global_suicide, by = "year") %>% 
  rename( "USA" = "suicide_rate",  "Global" = "suicide_global") %>% 
  pivot_longer(
    USA:Global,
    names_to = "region",
    values_to = "suicide_rate"
  )

suicide_rate %>% 
  ggplot(aes(x = year, y = suicide_rate, color = region)) +
  geom_point() + geom_line() +
  labs(
    title = "1999-2017 Suicide Rate in the USA and global",
    x = "Year",
    y = "Suicides per 100k"
  )

```


On the other hand, the suicide rate in the USA increases overtime while it decreases in global. Therefore, we want to focus on the U.S. to explore the risk factors and promote effective preventive measures.

## Goal of our project

* Visualizing the general situation of suicide rate worldwide

* Understanding risk factors for suicide in U.S.

* Visualizing correlations of these risk factors with suicide in U.S.

* Visualizing the distribution of risk factors and suicide in the U.S.


# Related Work



# Initial Question

We aim to examine the risk factor for suicide and suicide rate in the USA. We want to visualize the association and data in innovative and interactive way. As stated above, our questions are as follows:

* What are potential risk factors for suicide? How could we visualize the association between these factors and suicide rate?

* How could we use shiny to visualize the distribution of risk factors and suicide rate in the USA?

* Could the model be generalized to other regions? How can we predict suicide rate using the constructed model?





# Tidy the Data

## Data Import


**Worldwide Suicide Data**

* World suicide data is from [here](https://www.kaggle.com/russellyates88/suicide-rates-overview-1985-to-2016), a Kaggle project dataset, including variables such as countries, year, sex, age, suicide number, population and GDP, which aimes to describe the general suicide rates among different countries, time, gender and age. The dataset is a complied dataset, coming from [United Nations Development Program](http://hdr.undp.org/en/indicators/137506), [World Banlk](http://hdr.undp.org/en/indicators/137506), [Suicide in the 21st Century ](https://www.kaggle.com/szamil/suicide-in-the-twenty-first-century/notebook) and [World Health Organization](http://www.who.int/mental_health/suicide-prevention/en/)

**USA Suicide Data and the potential risk factors data**

* The Per captial GDP of each States in 2007 is from [Wiki](https://en.wikipedia.org/wiki/List_of_U.S._states_by_GDP_per_capita), presenting a list of U.S states sorted by their gross domestic product (GDP) per capita from 2011-2018.

* The Average Yearly Percipitation of each state is from [NETSTATE.COM](https://www.netstate.com/states/tables/state_precipitation.htm), presenting a list of U.S. states sorted by their average yearly precipitation.

* The Average Temperature of each state is from   [USA.COM](http://www.usa.com/rank/us--average-temperature--metro-area-rank.htm?yr=9000&dis=&wist=&plow=&phigh=), presenting a list of U.S. areas sorted by their average temperature. 

* The marijuana data of each state is from [samhsa.gov](https://www.samhsa.gov/data/sites/default/files/cbhsq-reports/NSDUHsaePercentsExcelCSVs2017/NSDUHsaePercents2017.pdf), showing percentage of U.S. adults that have used cannabis within the past year from 2016 to 2017, by state.

* The alcohol consumption data of each state is from [NIH; NIAAA](https://www.openicpsr.org/openicpsr/project/105583/version/V3/view;jsessionid=F62F155BFF788FAB14D58B1EF8FFF774), showing apparent per Capita Alcohol Consumption: National, State, and Regional Trends in 1977-2017. We only select 2007 data.

## Data Cleaning

**Worldwide Suicide Data**



## Final Combined Dataset of USA suicide and risk factors

After we collecting data from different sources, we constructed a [merged dataset](./data/US_2017.csv) collecting multiple protential risk factors for suicide rate in different states in US, here is the discriptions:

**Suicide rate (2017)**: The number of suicide deaths cases per 100000 people in 2017.

**Female proportion (2017)**: The proportion of Female in 2017.

**Male proportion (2017)**: The proportion of Male in 2017.

**Female Suicide rate (2017)**: The number of female suicide deaths cases per 100000 females in 2017.

**Male Suicide rate (2017)**: The number of male suicide deaths cases per 100000 males in 2017.

**Age 5-14 (2017)**: The proportion of people between age 5-14 in 2017.

**Age 15-24 (2017)**: The proportion of people between age 15-24 in 2017.

**Age 25-34 (2017)**: The proportion of people between age 25-34 in 2017.

**Age 35-44 (2017)**: The proportion of people between age 35-44 in 2017.

**Age 45-54 (2017)**: The proportion of people between age 45-54 in 2017.

**Age 55-64 (2017)**: The proportion of people between age 55-64 in 2017.

**Age 65-74 (2017)**: The proportion of people between age 65-74 in 2017.

**Age 75-84 (2017)**: The proportion of people between age 75-84 in 2017.

**Age >85 (2017)**: The proportion of people between age over 85 in 2017.

**Alcohol consumption (2017)**: Alcohol consumption per capita in gallons in 2017.

**Marijuana usage (2017)**: Marijuana users percentage in 2017.

**Advanced degree (2017)**: The proportion of people who have advanced degree in 2017.

**Bachelors degree(2017)**: The proportion of people who have Bachelors degree in 2017.

**College degree (2017)**: The proportion of people who have College degree in 2017.

**Below college degree (2017)**: The proportion of people who have below college degree in 2017.

**GDP (2017)**: Gross Domestic Product in 2017 per capita in each State.

**Guns number per capita (2017)**: Averaged guns number per capita in 2017.

**Guns number registered (2017)**: Averaged guns number registered in 2017

**Precipitation**: Averaged Precipitation in inches.

**Temperature**: Averaged Temperature in F.

Another dataset we used is [Domectis suicide distribution dataset](./data/suicide_age_gender.xlsx) from 1999 to 2017. In this dataset, we have information about number of suicide cases in different year, states, gender and age groups and the population in each groups. Using this dataset, we can analyze how suicide cases change in each state in time and how suicide cases distributed in different gender and age groups.


# Subanalyses

## World-level insight

## US-level insight

To show how the suicide cases distributed in different states, we made a Crude Suicide Rate map allowing users to toggle between different years (1999-2017) and choose gender, demonstrating the changes in suicide rate over time and visualize regional differences across the U.S. The map demonstrates that there are significant changes over time and gender.

The line plot we made is to show the change of total suicide rate by year in US. We can see a stable increase by year and the truth that there are much more cases of suicide in male than in female.

To show the distribution of the risk factors, we construct a US map allowing users to choose the types of variables, visualizing regional differences across the U.S and a bar plot showing the intuitive number in different states. Users are also allowed to choose TOP n states they want to explore in both plots.

# Regression Analysis

We are interested in whether there is a linear association between suicide rate and some risk factors. We choose `suicide` as the mean outcome, `gun`, `alcohol`, `temperature`, `precipitation`, `marijuana`, `education`, `gdp` and `gender` as candidate covariates, each with 50 observations. 

One value of `gun` in Wyoming and one value of `temperature` in Rhode Island were missing. We replaced them with the mean value of other 49 observations. 

After tidying the [merged dataset](./data/US_2017.csv), we obtain the [regression dataset](./data/regression_data.csv). The description of the dataset is shown below:

| Variables  | Description   |
| :------------------: | :----------------------------------------------------------------------------------: |
| state  | State  |
| suicide  | Suicide rate per 100000 population  |
| gun  | Number of guns per 1000 population  |
| alcohol  | Alcohol consumption per capita (gallons of ethanol)|
| temperature  | Average temperature (F)     |
| precipitation |  Average precipitation (inches) |                         
| marijuana  | Marijuana use in adults (%)
| education    | Educational attainment - bachelor's degree or higher (%)   |
| gdp    | GDP per capita (dollars)   |
| gender    | Male (%)   |


```{r, message = FALSE}
regression_data = read_csv("./data/us_2017.csv") %>%
  janitor::clean_names() %>% 
  filter(state != "District of Columbia") %>% 
  mutate(
    suicide = suicide_rate,
    gun = guns_number_per_capita_average,
    alcohol = alcohol_consumption,
    marijuana = marijuana_usage * 100,
    education = (advanced_degree + bachelors_degree) * 100,
    gender = male_proportion * 100
    ) %>% 
  select(state, suicide, gun, alcohol, temperature, precipitation, marijuana, education, gdp, gender) %>% 
  # replace missing value with mean value
  mutate(
    gun = replace_na(gun, mean(gun, na.rm = TRUE)),
    temperature = replace_na(temperature, mean(temperature, na.rm = TRUE)))
```

## Simple linear regression

First, we used scatter plot to see the relationship between suicide rate and each covariate. The scatter plots with linear regression line are shown below:

```{r}
# gun
gun_plot = 
  regression_data %>% 
  ggplot(aes(x = gun, y = suicide)) +
  geom_point() +
  geom_smooth(method = lm, color = "red",show.legend = FALSE, se = TRUE) 

# alcohol
alcohol_plot =
  regression_data %>% 
  ggplot(aes(x = alcohol, y = suicide)) +
  geom_point() +
  geom_smooth(method = lm, color = "red",show.legend = FALSE, se = TRUE) 

# temperature
temp_plot =
  regression_data %>% 
  ggplot(aes(x = temperature, y = suicide)) +
  geom_point() +
  geom_smooth(method = lm, color = "red",show.legend = FALSE, se = TRUE) 

# precipitation
precip_plot =
  regression_data %>% 
  ggplot(aes(x = precipitation, y = suicide)) +
  geom_point() +
  geom_smooth(method = lm, color = "red",show.legend = FALSE, se = TRUE) 

# marijuana
mari_plot =
  regression_data %>% 
  ggplot(aes(x = marijuana, y = suicide)) +
  geom_point() +
  geom_smooth(method = lm, color = "red",show.legend = FALSE, se = TRUE) 

# education
edu_plot =
  regression_data %>% 
  ggplot(aes(x = education, y = suicide)) +
  geom_point() +
  geom_smooth(method = lm, color = "red",show.legend = FALSE, se = TRUE) 

# gdp
gdp_plot =
  regression_data %>% 
  ggplot(aes(x = gdp, y = suicide)) +
  geom_point() +
  geom_smooth(method = lm, color = "red",show.legend = FALSE, se = TRUE) 

# gender
gender_plot = 
  regression_data %>% 
  ggplot(aes(x = gender, y = suicide)) +
  geom_point() +
  geom_smooth(method = lm, color = "red",show.legend = FALSE, se = TRUE) 
                      
ggarrange(gun_plot, alcohol_plot, temp_plot, precip_plot, mari_plot, edu_plot, gdp_plot, gender_plot, nrow = 3, ncol = 3) 
```

## Multiple linear regression

### Model building

Next, we used automatic procedures (stepwise elimination) to cut down covariates.

```{r}
fit1 = lm(suicide ~.-state,data = regression_data)
step(fit1) 
```

```{r}
fit2 = lm(suicide ~ gun + temperature + marijuana + education + gender +gdp, data = regression_data)
fit2 %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 4)

fit2 %>% 
  broom::glance() %>%   
  knitr::kable(digits = 4)
```

### Model diagnosis

```{r}
par(mfrow = c(2,2))
plot(fit2)
```

Basically, the residual assumptions are satisfied. However, 26 and 50 may be infludential. Then, we tried to fit model without 26 and 50. 

```{r}
fit3 = lm(suicide ~ gun + temperature + marijuana + education + gender +gdp, data = regression_data[-c(26,50),])
par(mfrow = c(2,2))
plot(fit3)

fit3 %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 4)
```

The coefficients of model change slightly, except for temperature(over 10%). We decided to retain 26 and 50. 

### Visualize model coefficients

```{r, message = FALSE}
GGally::ggcoef(fit2,aes(x = estimate, y = term, color =  term),size = 0.8,
               exclude_intercept = T,sort = "ascending") +
  labs(title = "95% CI for Model Coefficients")
```

__Results:__

* "alcohol" and "precipitation" were removed from the model. 

* The fitted equation is "suicide = -143.99 + 0.12gun - 0.10temperature + 0.25marijuana - 0.23education + 3.56gender - 0.0002gdp". 

* Adjusted R-square is 0.8124, which means these variables can explain a large proportion of variance in the suicide rate. 

* According to the results, suicide rate is higher in states where there is a higher gun ownership rate, higher marijuana usage, higher ratio of males to females, lower temperature and lower educational attainment.

* Holding other variables constant, for one unit increase in gun ownership(per 1,000), marijuana use in adults(%), or for one unit decrease in  proportion of male (%), GDP per capita (dollars), the suicide rate(per 100,000 population) will respectively increase by 0.13, 0.27, 3.11, or decrease by 0.22, 0.0002 on avarage. 


# Discussion 



